cmake_minimum_required(VERSION 3.16)
project(llama-dds)

# CycloneDDS installation path (local build)
set(CYCLONEDDS_INSTALL_PREFIX "/home/zet/cyclonedds/install")

# Find CycloneDDS
find_package(CycloneDDS QUIET PATHS "${CYCLONEDDS_INSTALL_PREFIX}" NO_DEFAULT_PATH)
find_package(CycloneDDS-CXX QUIET PATHS "${CYCLONEDDS_INSTALL_PREFIX}" NO_DEFAULT_PATH)

if (NOT CycloneDDS_FOUND OR NOT CycloneDDS-CXX_FOUND)
    message(STATUS "CycloneDDS not found, DDS support will be disabled")
    return()
endif()

message(STATUS "CycloneDDS found at: ${CYCLONEDDS_INSTALL_PREFIX}")

message(STATUS "CycloneDDS found: ${CycloneDDS_CONFIG}")

# IDL types generated from LlamaDDS.idl
# These are C types generated by idlc
set(IDL_SOURCES
    ${CMAKE_CURRENT_SOURCE_DIR}/idl/LlamaDDS.c
    ${CMAKE_CURRENT_SOURCE_DIR}/idl/LlamaDDS.h
)

set(DDS_SOURCES
    dds_transport.cpp
    dds_bridge.cpp
    ${IDL_SOURCES}
)

add_library(llama-dds OBJECT ${DDS_SOURCES})

target_include_directories(llama-dds PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${CMAKE_CURRENT_SOURCE_DIR}/idl
    ${CMAKE_SOURCE_DIR}
    ${CMAKE_SOURCE_DIR}/common
    ${CMAKE_SOURCE_DIR}/include
    ${CMAKE_SOURCE_DIR}/src
    ${CMAKE_SOURCE_DIR}/vendor
    ${CMAKE_SOURCE_DIR}/vendor/nlohmann
    ${CMAKE_SOURCE_DIR}/ggml/include
    ${CMAKE_SOURCE_DIR}/ggml/src
    ${CycloneDDS_INCLUDE_DIRS}
    ${CYCLONEDDS_INSTALL_PREFIX}/include
)

target_link_libraries(llama-dds PUBLIC
    CycloneDDS::ddsc
)

# Generate version info
target_compile_definitions(llama-dds PRIVATE
    LLAMA_DDS_VERSION_MAJOR=${llama_VERSION_MAJOR}
    LLAMA_DDS_VERSION_MINOR=${llama_VERSION_MINOR}
    LLAMA_DDS_VERSION_PATCH=${llama_VERSION_PATCH}
)

# Install headers
install(DIRECTORY . DESTINATION include/dds
    FILES_MATCHING PATTERN "*.h"
)


# Test Client
add_executable(test_client test_client.cpp)
target_link_libraries(test_client PRIVATE llama-dds CycloneDDS::ddsc)
target_include_directories(test_client PRIVATE ${CMAKE_CURRENT_SOURCE_DIR} ${CMAKE_SOURCE_DIR})

# Benchmark Final
add_executable(benchmark_final benchmark_final.cpp)
target_link_libraries(benchmark_final PRIVATE llama-dds CycloneDDS::ddsc)
target_include_directories(benchmark_final PRIVATE ${CMAKE_CURRENT_SOURCE_DIR} ${CMAKE_SOURCE_DIR})

