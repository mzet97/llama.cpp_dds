#!/usr/bin/env python3
"""
Generate comparative plots for DDS vs HTTP benchmarks.
Reads CSV files generated by benchmark_final (DDS) and benchmark_http.py (HTTP).
"""

import sys
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
import os

def load_data(dds_file, http_file):
    try:
        df_dds = pd.read_csv(dds_file)
        df_dds['protocol'] = 'DDS'
        
        df_http = pd.read_csv(http_file)
        df_http['protocol'] = 'HTTP'
        
        return pd.concat([df_dds, df_http])
    except Exception as e:
        print(f"Error loading CSV files: {e}")
        sys.exit(1)

def plot_comparison(df, output_dir):
    os.makedirs(output_dir, exist_ok=True)
    
    prompts = df['prompt_type'].unique()
    metrics = ['mean', 'p95', 'p99']
    
    # Set style
    plt.style.use('ggplot')
    
    # 1. Bar Chart: Mean Latency Comparison
    plt.figure(figsize=(10, 6))
    
    x = np.arange(len(prompts))
    width = 0.35
    
    dds_means = df[df['protocol'] == 'DDS']['mean'].values
    http_means = df[df['protocol'] == 'HTTP']['mean'].values
    
    # Handle missing data if any
    if len(dds_means) != len(prompts) or len(http_means) != len(prompts):
        print("Warning: Data mismatch between protocols")
        return

    plt.bar(x - width/2, dds_means, width, label='DDS')
    plt.bar(x + width/2, http_means, width, label='HTTP')
    
    plt.xlabel('Prompt Complexity')
    plt.ylabel('Mean Latency (ms)')
    plt.title('DDS vs HTTP: Mean Latency Comparison')
    plt.xticks(x, prompts)
    plt.legend()
    plt.grid(True, axis='y')
    
    # Add value labels
    for i, v in enumerate(dds_means):
        plt.text(i - width/2, v, f'{v:.1f}', ha='center', va='bottom')
    for i, v in enumerate(http_means):
        plt.text(i + width/2, v, f'{v:.1f}', ha='center', va='bottom')
        
    plt.savefig(os.path.join(output_dir, 'latency_comparison.png'))
    print(f"Saved latency_comparison.png to {output_dir}")
    
    # 2. Bar Chart: Speedup Factor (HTTP / DDS)
    plt.figure(figsize=(10, 6))
    
    speedup = http_means / dds_means
    colors = ['green' if s > 1 else 'red' for s in speedup]
    
    plt.bar(prompts, speedup, color=colors)
    plt.axhline(y=1.0, color='black', linestyle='-')
    
    plt.ylabel('Speedup Factor (Higher is Better)')
    plt.title('DDS Speedup over HTTP')
    
    for i, v in enumerate(speedup):
        plt.text(i, v, f'{v:.2f}x', ha='center', va='bottom')
        
    plt.savefig(os.path.join(output_dir, 'speedup_factor.png'))
    print(f"Saved speedup_factor.png to {output_dir}")

def main():
    if len(sys.argv) < 3:
        print("Usage: python3 plot_benchmarks.py <dds_csv> <http_csv> [output_dir]")
        sys.exit(1)
        
    dds_csv = sys.argv[1]
    http_csv = sys.argv[2]
    output_dir = sys.argv[3] if len(sys.argv) > 3 else "."
    
    print(f"Processing {dds_csv} and {http_csv}...")
    df = load_data(dds_csv, http_csv)
    
    print("Generating plots...")
    plot_comparison(df, output_dir)
    print("Done.")

if __name__ == "__main__":
    main()
